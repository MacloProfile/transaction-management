{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Генерация QR</title>
    <link rel="stylesheet" href="{% static 'css/menu.css' %}">
    <link rel="stylesheet" href="{% static 'css/qr_generator.css' %}">
</head>
<body>
<main>
    <div class="nav-buttons">
        <a href="{% url 'core:main_menu' %}" class="button">Главное меню</a>
    </div>

    <h1>Создание QR-кода для товара</h1>

    {% if error %}
      <div class="error-message" style="
          border: 2px solid #ff4d4f;
          background-color: #fff1f0;
          color: #a8071a;
          padding: 10px 15px;
          border-radius: 8px;
          margin-top: 10px;
          font-weight: 500;
      ">
        ❗️ {{ error }}
      </div>
    {% endif %}

    <form method="post" autocomplete="off">
        {% csrf_token %}
        <label for="product_input">Выберите товар:</label>
        <div class="autocomplete" style="margin-bottom: 15px;">
            <input type="text" id="product_input" class="autocomplete-input" placeholder="Начните вводить название товара..." required>
            <input type="hidden" name="product_id" id="product_id">
            <div id="autocomplete-list" class="autocomplete-items"></div>
        </div>

        <div style="margin-bottom: 15px;">
            <label for="valid_until">Ссылка действительна до:</label>
            <input type="date" id="valid_until" name="valid_until" required>
        </div>

        <button type="submit" class="but">Создать QR</button>
    </form>

    {% if qr_base64 %}
    <div class="qr-box">
        <h2>{{ product.NAME }}</h2>
        <p><b>Цена:</b> {{ product.PRICE }} {{ product.CURRENCY_ID }}</p>
        <img src="data:image/png;base64,{{ qr_base64 }}" alt="QR код товара">
        <p><b>Ссылка:</b> <a href="{{ qr_link }}" target="_blank">{{ qr_link }}</a></p>
        <p><b>Действительна до:</b> {{ valid_until }}</p>
    </div>
    {% endif %}
</main>

<script>
const products = [
    {% for p in products %}
    { id: '{{ p.ID }}', name: '{{ p.NAME }}', price: '{{ p.PRICE }}', currency: '{{ p.CURRENCY_ID }}' },
    {% endfor %}
];

const input = document.getElementById('product_input');
const hiddenInput = document.getElementById('product_id');
const list = document.getElementById('autocomplete-list');

input.addEventListener('input', function() {
    const val = this.value.toLowerCase();
    list.innerHTML = '';
    hiddenInput.value = '';
    if (!val) return;

    const filtered = products.filter(p => p.name.toLowerCase().includes(val));
    filtered.forEach(p => {
        const item = document.createElement('div');
        item.classList.add('autocomplete-item');
        const regex = new RegExp(`(${val})`, 'gi');
        item.innerHTML = `${p.name.replace(regex, '<span class="highlight">$1</span>')} (${p.price} ${p.currency})`;
        item.addEventListener('click', () => {
            input.value = p.name;
            hiddenInput.value = p.id;
            list.innerHTML = '';
        });
        list.appendChild(item);
    });
});

document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete')) {
        list.innerHTML = '';
    }
});
</script>
</body>
</html>
